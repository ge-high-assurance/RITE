"""Example workflow driver that echos stuff to the user"""

import sys
import xml.etree.ElementTree as ET

import riteworkflow

def main():
    """Read an XML form from stdin and write a reply XML to stdout."""

    # Read all of stdin
    input_string = sys.stdin.read()
    
    # Parse the input string into a Python dictionary representation
    input_form = riteworkflow.decode(input_string)

    # Find the control with id="user_input" and save its body
    user_input = ""
    for box in input_form.get('box', []):
        for control in box.get('control', []):
            if control.get('@id') == 'user_input':
                user_input = control.get('$', '')

    # Generate an output form echoing the previous input and requesting
    # yet more text from the user.
    output_form = {
        '@workflow': 'echo_workflow',
        'box': [
            {'control': [
                {
                    '@type': 'label',
                    '$': 'Echoed text:'
                },

                {
                    '@type': 'textbox',
                    '@id': 'message_to_user',
                    '@readonly': 'readonly',
                    '$': user_input,
                },

                {
                    '@type': 'label',
                    '$': 'Enter some text for me to echo:'
                },

                {
                    '@type': 'textbox',
                    '@id': 'user_input',
                },
            ]}
        ],
    }

    # Encode the Python dictionary into an XML object
    output_xml = riteworkflow.encode(output_form)
    
    # Write the XML object out as a string to stdout
    sys.stdout.write(ET.tostring(output_xml, encoding='utf-8').decode('utf-8'))
